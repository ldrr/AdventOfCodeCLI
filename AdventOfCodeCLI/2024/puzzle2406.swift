//
//  puzzle24.06.swift
//  AdventOfCodeCLI
//
//  Created by Christoph Lederer on 06.12.24.
//

import Foundation

func puzzle2406() {
    let puzzle = Puzzle2406(input: puzzle2406Data2)
    print(puzzle.run1(countNeeded: true))
    print(puzzle.run2())
}

class Puzzle2406 {

    let originalGrid: [[GridType]]
    let originalStart: Pos
    var grid: [[GridType]]
    var currentPos = Pos(x: 0, y: 0)
    var currentDirection = Direction.up
    var visitedPos: [Pos] = []

    init(input: String) {
        self.grid = input.components(separatedBy: "\n").map { $0.map { GridType(from: $0) } }
        for y in 0..<grid.count {
            for x in 0..<grid[y].count {
                if grid[y][x] == .start {
                    self.currentPos = Pos(x: x, y: y)
                    self.grid[y][x] = .visited
                    break
                }
            }
        }
        self.originalStart = self.currentPos
        self.originalGrid = self.grid
    }

    enum Direction: Int {
        case up, right, down, left

        func nextDirection() -> Self {
            Direction(rawValue: self.rawValue.advanced(by: 1)) ?? .up
        }

        func nextPos(from pos: Pos) -> Pos {
            switch self {
            case .up: return Pos(x: pos.x, y: pos.y - 1)
            case .down: return Pos(x: pos.x, y: pos.y + 1)
            case .right: return Pos(x: pos.x + 1, y: pos.y)
            case .left: return Pos(x: pos.x - 1, y: pos.y)
            }
        }
    }

    enum GridType {
        case empty // = "."
        case wall // = "#"
        case start // = "^"
        case visited // = "X"
        case turnedToTop // = "┗"
        case turnedToRight // = "┏"
        case turnedToBottom // = "┓"
        case turnedToLeft // = "┛"

        var isTurned: Bool {
            self == .turnedToTop || self == .turnedToRight || self == .turnedToBottom || self == .turnedToLeft
        }

        init(from: Character) {
            switch from {
            case "#":
                self = .wall
            case "^":
                self = .start
            default:
                self = .empty
            }
        }
    }


    struct Pos: Hashable {
        let x, y: Int
    }

    func isValid(pos: Pos) -> Bool {
        pos.x >= 0 && pos.y >= 0 && pos.x < grid[0].count && pos.y < grid.count
    }

    func run1(countNeeded: Bool = true) -> Int {
        var running = true
        var turnPositions: [Int: Bool] = [:]

        while(running) {
            let newPos = self.currentDirection.nextPos(from: self.currentPos)
            guard isValid(pos: newPos) else {
                running = false
                break
            }

            if(!countNeeded) {
                let key = self.currentPos.x * 10000 + self.currentPos.y * 10 + self.currentDirection.rawValue
                if turnPositions[key] ?? false {
                    return -1
                }
                turnPositions[key] = true
            }
            switch self.grid[newPos.y][newPos.x] {
            case .empty, .visited, .start, .turnedToTop, .turnedToRight, .turnedToBottom, .turnedToLeft:
                self.currentPos = newPos
                if(countNeeded && self.grid[newPos.y][newPos.x] == .empty) {
                    visitedPos.append(newPos)
                }
                self.grid[self.currentPos.y][self.currentPos.x] = .visited
            case .wall:
                self.grid[self.currentPos.y][self.currentPos.x] = {
                    switch self.currentDirection {
                    case .up: return .turnedToRight
                    case .right: return .turnedToBottom
                    case .down: return .turnedToLeft
                    case .left: return .turnedToTop
                    }
                }()
                self.currentDirection = self.currentDirection.nextDirection()
            }
        }
        guard countNeeded else { return 1 }
        return self.grid.reduce(0) { partialResult, row in
            partialResult + row.reduce(0, { partialResult, type in
                partialResult + (type == .visited || type.isTurned ? 1 : 0)
            })
        }
    }

    func run2() -> Int {

        var counter = 0
        self.grid = self.originalGrid

        for pos in self.visitedPos {
            self.currentPos = self.originalStart
            self.currentDirection = .up
            self.grid[pos.y][pos.x] = .wall
            if self.run1(countNeeded: false) < 0 {
                counter += 1
            }
            self.grid[pos.y][pos.x] = .empty

            print(pos)
        }

        return counter
    }
}

let puzzle2406Data1 = """
....#.....
.........#
..........
..#.......
.......#..
..........
.#..^.....
........#.
#.........
......#...
"""

let puzzle2406Data2 = """
.........#..................#.......#...............#..................................#.....................................#....
..#....................................#...#......#....................#..........................................................
..........................................................#..#.#................#............#....................#...............
...........................................................#......................................................#...............
............................#..........#................................................#............#.#....................#.....
...........#............................#............................................#...........................................#
......#..................#..#...........#.......................#..........#.....................#...........#...#......#.....#...
...#........................................................................................................#.............#.......
.......................#....................................#.....................#...#.#.....##.........................#........
..............#........#..............................................................................#..........#........#.......
.#........................................................................#....#..#....#.....................................#....
..........#.....................#....#.#.......................#................#.#.............#.......#.......#..........#......
......#..#...............................#.###......................................................#...#.........................
...............................................#....................#...#.......................#...........#...#.................
....#...#..#.............#................................................................#.......................................
...............#...#............#....................#.............#................#.......#....#.......................#........
.........#..........................#............#..............................................................#.#...............
..........................##..............................#....................................#..................................
.......#..##.........................#..............#..#......#..............#...............................##...................
.............................................#........................................................................#....#......
.........................#.......#.......#.......##.#.........#...................................................................
#......................................................................................#.......#......#.#................#......#.
...#.............#....#.............#.....................#................................................................#......
...........#.....................#............................#..............................#.....#........#.....................
.................#....#.#............#.....#................#.....................#..#............................................
..........................#......................#...............#.#...#..............................#.........#.................
...........................................................#......................................................#......#........
........#.........................#.................................#.....................................#.......................
....................#........#.....................................#...............#................#.......................#.....
....#...............#.............................................................................................................
##..................................................................................#.....................................#..#....
........................#..............#......#...................................#.........#.......#.....#.....#.................
.........#.............#......................#............#.......................................................#..........#...
.....#...............#......................................................................#.........#..................#........
....................#...#..............#...............#.............#.............#......#..#......#................#......#.....
............#..........................................#.........................................#........#.......................
.......#.....#........#....................#...............#............................................................#.........
..................#..#.............................................#........#..........................................#..........
...................................#...............................................................#.......#................#.#...
.......................#.....#.........#..................##........#.............................................................
.....#.................................................................................#............#........................#....
....#..........#.........#................................#.....................................#..................##.............
.#.........#..............#.................#...............................................#...............................#.....
........................#.......................................................#.....#................#..............#...........
.........................#.............................#.......#..................##..........................................#...
...................#...................#............#......#......................##........................#...#.....#...........
......#......#....#......................................................................................#........................
#............#........##............................#............................................#....#.......#.................#.
...........................................................#..............................................#.......#...#...........
...##...#............#.....#...............#..................#....................#..............#.............................#.
.....................................................................#................................#.......#.................#.
......#......#.......................................................#....#.................#.....................#...#.#....#.#..
...................#.........#..............#.................................#...#.......#.......................................
........##.....#.......#............................#...................................................................#.........
...................................#.........................................................................#...#...........#....
....#.....................................#......................................................#...#..........#.....#...........
..................................................................................................#........#....................#.
.........#....................##.................................#.......................#........#......#......................#.
.....#.....#....#............#..............#....#.........#............#.#...............#.......................#...............
...................................#.......................#..........................#.....................................#....#
..........#....#...........#.........#..............#.....#................................................#.........#............
...#.........#....................................................................................................................
.#.........................#........................................#.....#...................................#.............#.....
.......................#...#...#...#.......##..................##......................................#........................#.
............................................#....#..........................................##............................#.......
..#.................................................................#....#....#....##...........................................#.
.............#........#.#........#.....................##.....................................................#..#................
............................................##.......................................................................##...........
.........#...................#.................................#....#.#.............................#......#.#.#.....#.........#..
.........................#...........#...........#............................................#......#..................#.........
#.............................##...............#..........#...................#......................................#........#...
...................#.............................................................................................#.......#........
..........................................#.#......................................#........#...........##.......................#
...................#........#.#......#....................................#.......#...........................#..................#
......#................................................................................................#..........................
......................###.............#...................#.#...............................................#.....................
.....#......#......#.....#.#..................#.#...#.....................................................................#.......
.............................................#..............#....................##...............................................
.........................................#..#.............#................................................#...................#.#
........#............................#.................................................#..#.......................................
............#.............................#......................................#..........................##...#................
...................#.........#..................................................................#.............#...................
..#..#..............#....................#...................................................................#....................
............................#..................#..................................................................................
.........................#.....................................................................................#...............#..
.........#....................#.#.............##..................#...#...........................................................
........#..............................#..........................................#.#.........................#...................
.#........#....................##.............................................#............#......................................
...#.....................................#......#.#..#.....#............................#.......................................#.
....................#.........................................#.#.................................#.........#................#....
..............#..........#......#.........................#..#..................#..#...................#.................#...#....
................#..........................................#.............................#......#..............#.#...##...........
........................#.....#.......................#...#................#.......#................#.............................
........#..#..........#....#..#.............................................#...................#........#.................#.#....
...........................#.............................................................#..#................................#.#..
...........#.............#........................................#.^.................................................#...........
..........#.#..#......#........................................................................................#....#.............
...............#......#...#....#..................................#.......#.......................................................
..........##...##....#.....................#...#................................................................#......#..........
.............................................#................................................................................###.
........#.......#..........#....#....................#....................#....#.....#............................................
......#.............................................................................#...........##...#......##....................
.......#.............................#............#.......................#............#...#......................................
..#........#.....#......................................................................................................#.........
.....#....#......................#.....................................................................#..........................
.#.......#...........#....#.......#..............#...#..............#........#..........##.....#......#.................#.........
.............#.#....................................................#........#..............#.....#......................#...#....
...........#.............................................#...........................#.........##................#..#.....#.......
.........................................#.................................................................#.......#.#............
...............#....................#..........................#.............#......#....#...#..............#..................#..
........#...............#.........................................................................................................
..............................#............................#.#...................................#........#................#......
...........#........#.............................#...............................#................#.............#........#.......
.............................#...#..#...........#...........#.............................#..............................#........
......................................................................................................................#........#..
..............##...........#..........................................#...#..............#........................................
..............#.................#......................................................#..#........#..........................#...
..............................................#.......................#........................................................#..
.................#..#...................#..............................#.......................................#.#......#.........
...........#..........#................#.............#...................................................#.......#.....#..........
...#...#...............................................................................................#................#..#.#.#..
...#.....................................................................................#...............................#........
..........................#............................#.#..#..................#.#.......................#.#................##...#
...............................................................................................#....##............................
............................................#....................#....................................................#...........
...............#.......#...#.................................#.......................................#...#..#.#...................
.......#.....#.....#..................#..............#................#..........#........#.......................................
...#...#..........##....................#.......#.......#...........................#....................................#.....#..
..................................................#...#.#...#.........#.#.#.......##.....##.................................#.....
...#..#..........................#..#...........................#...............#.....#.......#............................#......
"""
