//
//  puzzle24.06.swift
//  AdventOfCodeCLI
//
//  Created by Christoph Lederer on 06.12.24.
//

import Foundation

func puzzle2406() {

    // Ensure the file path is provided as a CLI argument
    guard CommandLine.arguments.count > 1 else {
        print("Please provide a file path as a command-line argument.")
        exit(1)
    }

    guard let data = try? String(contentsOf: URL(fileURLWithPath: CommandLine.arguments[1]), encoding: .ascii) else {
        print("error reading file")
        exit(1)
    }

    var puzzle = Puzzle2406(input: data)
    _ = puzzle.part1()
    print(puzzle.part2())
}

struct Puzzle2406 {

    let originalGrid: [[GridType]]
    let originalStart: Pos
    var grid: [[GridType]]
    var currentPos = Pos(x: 0, y: 0)
    var currentDirection = 0
    var visitedPos: [Pos] = []
    var array: [Int16] = Array(repeating: 0, count: 2500000)

    init(input: String) {
        self.grid = input.components(separatedBy: "\n").compactMap {
            let row = $0.map { GridType(from: $0) }
            return row.count > 0 ? row : nil
        }
        for y in 0..<grid.count {
            for x in 0..<grid[y].count {
                if grid[y][x] == .start {
                    self.currentPos = Pos(x: x, y: y)
                    self.grid[y][x] = .visited
                    break
                }
            }
        }
        self.originalStart = self.currentPos
        self.originalGrid = self.grid
    }

    enum GridType: Int {
        case empty // = "."
        case wall // = "#"
        case start // = "^"
        case visited // = "X"

        init(from: Character) {
            switch from {
            case "#":
                self = .wall
            case "^":
                self = .start
            default:
                self = .empty
            }
        }
    }

    struct Pos {
        var x, y: Int
    }

    @inlinable var nextPos: Pos {
        if self.currentDirection == 0 {
            return Pos(x: self.currentPos.x, y: self.currentPos.y - 1)
        }
        if self.currentDirection == 1 {
            return Pos(x: self.currentPos.x + 1, y: self.currentPos.y)
        }
        if self.currentDirection == 2 {
            return Pos(x: self.currentPos.x, y: self.currentPos.y + 1)
        }
        return Pos(x: self.currentPos.x - 1, y: self.currentPos.y)
    }

    @inlinable mutating func part1() -> Int {
        while(true) {
            let newPos = self.nextPos

            // exit check
            guard newPos.x >= 0 && newPos.y >= 0 && newPos.x < grid[0].count && newPos.y < grid.count else {
                return self.grid.reduce(0) { partialResult, row in
                    partialResult + row.reduce(0, { partialResult, type in
                        partialResult + (type == .visited ? 1 : 0)
                    })
                }
            }

            if self.grid[newPos.y][newPos.x] == .wall {
                self.currentDirection = (self.currentDirection + 1) % 4
            } else {
                self.currentPos = newPos
                if self.grid[newPos.y][newPos.x] == .empty {
                    visitedPos.append(newPos)
                }
            }
            self.grid[self.currentPos.y][self.currentPos.x] = .visited
        }
    }

    var newPos = Pos(x: 0, y: 0)

    @inlinable mutating func part2isLoop() -> Int {

        newPos.x = originalStart.x
        newPos.y = originalStart.y

        while(true) {
            if self.currentDirection == 0 {

                if newPos.y < 1 { return 0 }

                if self.grid[newPos.y - 1][newPos.x] == .wall {
                    let key = (newPos.x << 12) | (newPos.y << 4) | self.currentDirection
                    if array[key] == loop {
                        return 1
                    }
                    array[key] = loop
                    self.currentDirection = (self.currentDirection + 1) % 4
                } else {
                    newPos.y = newPos.y - 1
                }

            } else if self.currentDirection == 1 {
                if newPos.x + 1 >= grid[0].count { return 0 }
                if self.grid[newPos.y][newPos.x + 1] == .wall {
                    let key = (newPos.x << 12) | (newPos.y << 4) | self.currentDirection
                    if array[key] == loop {
                        return 1
                    }
                    array[key] = loop
                    self.currentDirection = (self.currentDirection + 1) % 4
                } else {
                    newPos.x = newPos.x + 1
                }
            } else if self.currentDirection == 2 {

                if newPos.y + 1 >= grid.count { return 0 }
                if self.grid[newPos.y + 1][newPos.x] == .wall {
                    let key = (newPos.x << 12) | (newPos.y << 4) | self.currentDirection
                    if array[key] == loop {
                        return 1
                    }
                    array[key] = loop
                    self.currentDirection = (self.currentDirection + 1) % 4
                } else {
                    newPos.y = newPos.y + 1
                }
            } else {
                if newPos.x < 1 { return 0 }
                if self.grid[newPos.y][newPos.x - 1] == .wall {
                    let key = (newPos.x << 12) | (newPos.y << 4) | self.currentDirection
                    if array[key] == loop {
                        return 1
                    }
                    array[key] = loop
                    self.currentDirection = (self.currentDirection + 1) % 4
                } else {
                    newPos.x = newPos.x - 1
                }
            }
        }
    }

    var loop: Int16 = 1

    mutating func part2() -> Int {

        var counter = 0
        self.grid = self.originalGrid

        for pos in self.visitedPos {
            self.currentDirection = 0
            self.grid[pos.y][pos.x] = .wall
            counter += self.part2isLoop()
            self.grid[pos.y][pos.x] = .empty
            loop += 1
        }

        return counter
    }
}

private let puzzle2406Data1 = """
....#.....
.........#
..........
..#.......
.......#..
..........
.#..^.....
........#.
#.........
......#...
"""

private let puzzle2406Data2 = """
.........#..................#.......#...............#..................................#.....................................#....
..#....................................#...#......#....................#..........................................................
..........................................................#..#.#................#............#....................#...............
...........................................................#......................................................#...............
............................#..........#................................................#............#.#....................#.....
...........#............................#............................................#...........................................#
......#..................#..#...........#.......................#..........#.....................#...........#...#......#.....#...
...#........................................................................................................#.............#.......
.......................#....................................#.....................#...#.#.....##.........................#........
..............#........#..............................................................................#..........#........#.......
.#........................................................................#....#..#....#.....................................#....
..........#.....................#....#.#.......................#................#.#.............#.......#.......#..........#......
......#..#...............................#.###......................................................#...#.........................
...............................................#....................#...#.......................#...........#...#.................
....#...#..#.............#................................................................#.......................................
...............#...#............#....................#.............#................#.......#....#.......................#........
.........#..........................#............#..............................................................#.#...............
..........................##..............................#....................................#..................................
.......#..##.........................#..............#..#......#..............#...............................##...................
.............................................#........................................................................#....#......
.........................#.......#.......#.......##.#.........#...................................................................
#......................................................................................#.......#......#.#................#......#.
...#.............#....#.............#.....................#................................................................#......
...........#.....................#............................#..............................#.....#........#.....................
.................#....#.#............#.....#................#.....................#..#............................................
..........................#......................#...............#.#...#..............................#.........#.................
...........................................................#......................................................#......#........
........#.........................#.................................#.....................................#.......................
....................#........#.....................................#...............#................#.......................#.....
....#...............#.............................................................................................................
##..................................................................................#.....................................#..#....
........................#..............#......#...................................#.........#.......#.....#.....#.................
.........#.............#......................#............#.......................................................#..........#...
.....#...............#......................................................................#.........#..................#........
....................#...#..............#...............#.............#.............#......#..#......#................#......#.....
............#..........................................#.........................................#........#.......................
.......#.....#........#....................#...............#............................................................#.........
..................#..#.............................................#........#..........................................#..........
...................................#...............................................................#.......#................#.#...
.......................#.....#.........#..................##........#.............................................................
.....#.................................................................................#............#........................#....
....#..........#.........#................................#.....................................#..................##.............
.#.........#..............#.................#...............................................#...............................#.....
........................#.......................................................#.....#................#..............#...........
.........................#.............................#.......#..................##..........................................#...
...................#...................#............#......#......................##........................#...#.....#...........
......#......#....#......................................................................................#........................
#............#........##............................#............................................#....#.......#.................#.
...........................................................#..............................................#.......#...#...........
...##...#............#.....#...............#..................#....................#..............#.............................#.
.....................................................................#................................#.......#.................#.
......#......#.......................................................#....#.................#.....................#...#.#....#.#..
...................#.........#..............#.................................#...#.......#.......................................
........##.....#.......#............................#...................................................................#.........
...................................#.........................................................................#...#...........#....
....#.....................................#......................................................#...#..........#.....#...........
..................................................................................................#........#....................#.
.........#....................##.................................#.......................#........#......#......................#.
.....#.....#....#............#..............#....#.........#............#.#...............#.......................#...............
...................................#.......................#..........................#.....................................#....#
..........#....#...........#.........#..............#.....#................................................#.........#............
...#.........#....................................................................................................................
.#.........................#........................................#.....#...................................#.............#.....
.......................#...#...#...#.......##..................##......................................#........................#.
............................................#....#..........................................##............................#.......
..#.................................................................#....#....#....##...........................................#.
.............#........#.#........#.....................##.....................................................#..#................
............................................##.......................................................................##...........
.........#...................#.................................#....#.#.............................#......#.#.#.....#.........#..
.........................#...........#...........#............................................#......#..................#.........
#.............................##...............#..........#...................#......................................#........#...
...................#.............................................................................................#.......#........
..........................................#.#......................................#........#...........##.......................#
...................#........#.#......#....................................#.......#...........................#..................#
......#................................................................................................#..........................
......................###.............#...................#.#...............................................#.....................
.....#......#......#.....#.#..................#.#...#.....................................................................#.......
.............................................#..............#....................##...............................................
.........................................#..#.............#................................................#...................#.#
........#............................#.................................................#..#.......................................
............#.............................#......................................#..........................##...#................
...................#.........#..................................................................#.............#...................
..#..#..............#....................#...................................................................#....................
............................#..................#..................................................................................
.........................#.....................................................................................#...............#..
.........#....................#.#.............##..................#...#...........................................................
........#..............................#..........................................#.#.........................#...................
.#........#....................##.............................................#............#......................................
...#.....................................#......#.#..#.....#............................#.......................................#.
....................#.........................................#.#.................................#.........#................#....
..............#..........#......#.........................#..#..................#..#...................#.................#...#....
................#..........................................#.............................#......#..............#.#...##...........
........................#.....#.......................#...#................#.......#................#.............................
........#..#..........#....#..#.............................................#...................#........#.................#.#....
...........................#.............................................................#..#................................#.#..
...........#.............#........................................#.^.................................................#...........
..........#.#..#......#........................................................................................#....#.............
...............#......#...#....#..................................#.......#.......................................................
..........##...##....#.....................#...#................................................................#......#..........
.............................................#................................................................................###.
........#.......#..........#....#....................#....................#....#.....#............................................
......#.............................................................................#...........##...#......##....................
.......#.............................#............#.......................#............#...#......................................
..#........#.....#......................................................................................................#.........
.....#....#......................#.....................................................................#..........................
.#.......#...........#....#.......#..............#...#..............#........#..........##.....#......#.................#.........
.............#.#....................................................#........#..............#.....#......................#...#....
...........#.............................................#...........................#.........##................#..#.....#.......
.........................................#.................................................................#.......#.#............
...............#....................#..........................#.............#......#....#...#..............#..................#..
........#...............#.........................................................................................................
..............................#............................#.#...................................#........#................#......
...........#........#.............................#...............................#................#.............#........#.......
.............................#...#..#...........#...........#.............................#..............................#........
......................................................................................................................#........#..
..............##...........#..........................................#...#..............#........................................
..............#.................#......................................................#..#........#..........................#...
..............................................#.......................#........................................................#..
.................#..#...................#..............................#.......................................#.#......#.........
...........#..........#................#.............#...................................................#.......#.....#..........
...#...#...............................................................................................#................#..#.#.#..
...#.....................................................................................#...............................#........
..........................#............................#.#..#..................#.#.......................#.#................##...#
...............................................................................................#....##............................
............................................#....................#....................................................#...........
...............#.......#...#.................................#.......................................#...#..#.#...................
.......#.....#.....#..................#..............#................#..........#........#.......................................
...#...#..........##....................#.......#.......#...........................#....................................#.....#..
..................................................#...#.#...#.........#.#.#.......##.....##.................................#.....
...#..#..........................#..#...........................#...............#.....#.......#............................#......
"""
