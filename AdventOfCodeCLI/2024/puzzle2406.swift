//
//  puzzle24.06.swift
//  AdventOfCodeCLI
//
//  Created by Christoph Lederer on 06.12.24.
//

import Foundation

func puzzle2406() {

    // Ensure the file path is provided as a CLI argument
    guard CommandLine.arguments.count > 1 else {
        print("Please provide a file path as a command-line argument.")
        exit(1)
    }

    guard let data = try? String(contentsOf: URL(fileURLWithPath: CommandLine.arguments[1]), encoding: .ascii) else {
        print("error reading file")
        exit(1)
    }

    var puzzle = Puzzle2406(input: data)
    _ = puzzle.run1(countNeeded: true)
    print(puzzle.run2())
}

struct Puzzle2406 {

    let originalGrid: [[GridType]]
    let originalStart: Pos
    var grid: [[GridType]]
    var currentPos = Pos(x: 0, y: 0)
    var currentDirection = Direction.up
    var visitedPos: [Pos] = []
    var array = Array(repeating: false, count: 250000)

    init(input: String) {
        self.grid = input.components(separatedBy: "\n").compactMap {
            let row = $0.map { GridType(from: $0) }
            return row.count > 0 ? row : nil
        }
        for y in 0..<grid.count {
            for x in 0..<grid[y].count {
                if grid[y][x] == .start {
                    self.currentPos = Pos(x: x, y: y)
                    self.grid[y][x] = .visited
                    break
                }
            }
        }
        self.originalStart = self.currentPos
        self.originalGrid = self.grid
    }

    enum Direction: Int {
        case up, right, down, left

        @inlinable func nextDirection() -> Self {
            Direction(rawValue: self.rawValue.advanced(by: 1)) ?? .up
        }

        @inlinable func nextPos(from pos: Pos) -> Pos {
            switch self {
            case .up: return Pos(x: pos.x, y: pos.y - 1)
            case .down: return Pos(x: pos.x, y: pos.y + 1)
            case .right: return Pos(x: pos.x + 1, y: pos.y)
            case .left: return Pos(x: pos.x - 1, y: pos.y)
            }
        }
    }

    enum GridType: Int {
        case empty // = "."
        case wall // = "#"
        case start // = "^"
        case visited // = "X"
        case turnedToTop // = "┗"
        case turnedToRight // = "┏"
        case turnedToBottom // = "┓"
        case turnedToLeft // = "┛"

        var isTurned: Bool {
            self == .turnedToTop || self == .turnedToRight || self == .turnedToBottom || self == .turnedToLeft
        }

        init(from: Character) {
            switch from {
            case "#":
                self = .wall
            case "^":
                self = .start
            default:
                self = .empty
            }
        }
    }

    struct Pos {
        let x, y: Int
    }

    @inlinable mutating func run1(countNeeded: Bool = true) -> Int {
        // var running = true

        array = Array(repeating: false, count: 250000)

        while(true) {
            let newPos = self.currentDirection.nextPos(from: self.currentPos)
            guard newPos.x >= 0 && newPos.y >= 0 && newPos.x < grid[0].count && newPos.y < grid.count else {
                guard countNeeded else { return 1 }
                return self.grid.reduce(0) { partialResult, row in
                    partialResult + row.reduce(0, { partialResult, type in
                        partialResult + (type == .visited || type.isTurned ? 1 : 0)
                    })
                }
            }

            switch self.grid[newPos.y][newPos.x] {
            case .empty, .visited, .start, .turnedToTop, .turnedToRight, .turnedToBottom, .turnedToLeft:
                self.currentPos = newPos
                if(countNeeded && self.grid[newPos.y][newPos.x] == .empty) {
                    visitedPos.append(newPos)
                }
                self.grid[self.currentPos.y][self.currentPos.x] = .visited
            case .wall:
                self.grid[self.currentPos.y][self.currentPos.x] = {
                    switch self.currentDirection {
                    case .up: return .turnedToRight
                    case .right: return .turnedToBottom
                    case .down: return .turnedToLeft
                    case .left: return .turnedToTop
                    }
                }()
                if(!countNeeded) {
                    let key = (self.currentPos.x * 150 + self.currentPos.y) * 10 + self.currentDirection.rawValue
                    if array[key] {
                        return -1
                    }
                    array[key] = true
                }
                self.currentDirection = self.currentDirection.nextDirection()
            }
        }
    }

    mutating func run2() -> Int {

        var counter = 0
        self.grid = self.originalGrid

        for pos in self.visitedPos {
            self.currentPos = self.originalStart
            self.currentDirection = .up
            self.grid[pos.y][pos.x] = .wall
            if self.run1(countNeeded: false) < 0 {
                counter += 1
            }
            self.grid[pos.y][pos.x] = .empty
        }

        return counter
    }
}

let puzzle2406Data1 = """
....#.....
.........#
..........
..#.......
.......#..
..........
.#..^.....
........#.
#.........
......#...
"""

let puzzle2406Data2 = """
.........#..................#.......#...............#..................................#.....................................#....
..#....................................#...#......#....................#..........................................................
..........................................................#..#.#................#............#....................#...............
...........................................................#......................................................#...............
............................#..........#................................................#............#.#....................#.....
...........#............................#............................................#...........................................#
......#..................#..#...........#.......................#..........#.....................#...........#...#......#.....#...
...#........................................................................................................#.............#.......
.......................#....................................#.....................#...#.#.....##.........................#........
..............#........#..............................................................................#..........#........#.......
.#........................................................................#....#..#....#.....................................#....
..........#.....................#....#.#.......................#................#.#.............#.......#.......#..........#......
......#..#...............................#.###......................................................#...#.........................
...............................................#....................#...#.......................#...........#...#.................
....#...#..#.............#................................................................#.......................................
...............#...#............#....................#.............#................#.......#....#.......................#........
.........#..........................#............#..............................................................#.#...............
..........................##..............................#....................................#..................................
.......#..##.........................#..............#..#......#..............#...............................##...................
.............................................#........................................................................#....#......
.........................#.......#.......#.......##.#.........#...................................................................
#......................................................................................#.......#......#.#................#......#.
...#.............#....#.............#.....................#................................................................#......
...........#.....................#............................#..............................#.....#........#.....................
.................#....#.#............#.....#................#.....................#..#............................................
..........................#......................#...............#.#...#..............................#.........#.................
...........................................................#......................................................#......#........
........#.........................#.................................#.....................................#.......................
....................#........#.....................................#...............#................#.......................#.....
....#...............#.............................................................................................................
##..................................................................................#.....................................#..#....
........................#..............#......#...................................#.........#.......#.....#.....#.................
.........#.............#......................#............#.......................................................#..........#...
.....#...............#......................................................................#.........#..................#........
....................#...#..............#...............#.............#.............#......#..#......#................#......#.....
............#..........................................#.........................................#........#.......................
.......#.....#........#....................#...............#............................................................#.........
..................#..#.............................................#........#..........................................#..........
...................................#...............................................................#.......#................#.#...
.......................#.....#.........#..................##........#.............................................................
.....#.................................................................................#............#........................#....
....#..........#.........#................................#.....................................#..................##.............
.#.........#..............#.................#...............................................#...............................#.....
........................#.......................................................#.....#................#..............#...........
.........................#.............................#.......#..................##..........................................#...
...................#...................#............#......#......................##........................#...#.....#...........
......#......#....#......................................................................................#........................
#............#........##............................#............................................#....#.......#.................#.
...........................................................#..............................................#.......#...#...........
...##...#............#.....#...............#..................#....................#..............#.............................#.
.....................................................................#................................#.......#.................#.
......#......#.......................................................#....#.................#.....................#...#.#....#.#..
...................#.........#..............#.................................#...#.......#.......................................
........##.....#.......#............................#...................................................................#.........
...................................#.........................................................................#...#...........#....
....#.....................................#......................................................#...#..........#.....#...........
..................................................................................................#........#....................#.
.........#....................##.................................#.......................#........#......#......................#.
.....#.....#....#............#..............#....#.........#............#.#...............#.......................#...............
...................................#.......................#..........................#.....................................#....#
..........#....#...........#.........#..............#.....#................................................#.........#............
...#.........#....................................................................................................................
.#.........................#........................................#.....#...................................#.............#.....
.......................#...#...#...#.......##..................##......................................#........................#.
............................................#....#..........................................##............................#.......
..#.................................................................#....#....#....##...........................................#.
.............#........#.#........#.....................##.....................................................#..#................
............................................##.......................................................................##...........
.........#...................#.................................#....#.#.............................#......#.#.#.....#.........#..
.........................#...........#...........#............................................#......#..................#.........
#.............................##...............#..........#...................#......................................#........#...
...................#.............................................................................................#.......#........
..........................................#.#......................................#........#...........##.......................#
...................#........#.#......#....................................#.......#...........................#..................#
......#................................................................................................#..........................
......................###.............#...................#.#...............................................#.....................
.....#......#......#.....#.#..................#.#...#.....................................................................#.......
.............................................#..............#....................##...............................................
.........................................#..#.............#................................................#...................#.#
........#............................#.................................................#..#.......................................
............#.............................#......................................#..........................##...#................
...................#.........#..................................................................#.............#...................
..#..#..............#....................#...................................................................#....................
............................#..................#..................................................................................
.........................#.....................................................................................#...............#..
.........#....................#.#.............##..................#...#...........................................................
........#..............................#..........................................#.#.........................#...................
.#........#....................##.............................................#............#......................................
...#.....................................#......#.#..#.....#............................#.......................................#.
....................#.........................................#.#.................................#.........#................#....
..............#..........#......#.........................#..#..................#..#...................#.................#...#....
................#..........................................#.............................#......#..............#.#...##...........
........................#.....#.......................#...#................#.......#................#.............................
........#..#..........#....#..#.............................................#...................#........#.................#.#....
...........................#.............................................................#..#................................#.#..
...........#.............#........................................#.^.................................................#...........
..........#.#..#......#........................................................................................#....#.............
...............#......#...#....#..................................#.......#.......................................................
..........##...##....#.....................#...#................................................................#......#..........
.............................................#................................................................................###.
........#.......#..........#....#....................#....................#....#.....#............................................
......#.............................................................................#...........##...#......##....................
.......#.............................#............#.......................#............#...#......................................
..#........#.....#......................................................................................................#.........
.....#....#......................#.....................................................................#..........................
.#.......#...........#....#.......#..............#...#..............#........#..........##.....#......#.................#.........
.............#.#....................................................#........#..............#.....#......................#...#....
...........#.............................................#...........................#.........##................#..#.....#.......
.........................................#.................................................................#.......#.#............
...............#....................#..........................#.............#......#....#...#..............#..................#..
........#...............#.........................................................................................................
..............................#............................#.#...................................#........#................#......
...........#........#.............................#...............................#................#.............#........#.......
.............................#...#..#...........#...........#.............................#..............................#........
......................................................................................................................#........#..
..............##...........#..........................................#...#..............#........................................
..............#.................#......................................................#..#........#..........................#...
..............................................#.......................#........................................................#..
.................#..#...................#..............................#.......................................#.#......#.........
...........#..........#................#.............#...................................................#.......#.....#..........
...#...#...............................................................................................#................#..#.#.#..
...#.....................................................................................#...............................#........
..........................#............................#.#..#..................#.#.......................#.#................##...#
...............................................................................................#....##............................
............................................#....................#....................................................#...........
...............#.......#...#.................................#.......................................#...#..#.#...................
.......#.....#.....#..................#..............#................#..........#........#.......................................
...#...#..........##....................#.......#.......#...........................#....................................#.....#..
..................................................#...#.#...#.........#.#.#.......##.....##.................................#.....
...#..#..........................#..#...........................#...............#.....#.......#............................#......
"""
