//
//  puzzle24.06.swift
//  AdventOfCodeCLI
//
//  Created by Christoph Lederer on 06.12.24.
//

import Foundation

func puzzle2406() {
    let puzzle = Puzzle2406(input: puzzle2406Data2)
    print(puzzle.run2())
}
class Puzzle2406 {

    let originalGrid: [[GridType]]
    let originalStart: Pos
    var grid: [[GridType]]
    var currentPos = Pos(x: 0, y: 0)
    var currentDirection = Direction.up

    init(input: String) {
        self.grid = input.components(separatedBy: "\n").map { $0.map { GridType(rawValue: $0)! } }
        for y in 0..<grid.count {
            for x in 0..<grid[y].count {
                if grid[y][x] == .start {
                    self.currentPos = Pos(x: x, y: y)
                    self.grid[y][x] = .visited
                    break
                }
            }
        }
        self.originalStart = self.currentPos
        self.originalGrid = self.grid
    }

    enum Direction: Int {
        case up, right, down, left

        func nextDirection() -> Self {
            Direction(rawValue: self.rawValue.advanced(by: 1)) ?? .up
        }

        func nextPos(from pos: Pos) -> Pos {
            switch self {
            case .up: return Pos(x: pos.x, y: pos.y - 1)
            case .down: return Pos(x: pos.x, y: pos.y + 1)
            case .right: return Pos(x: pos.x + 1, y: pos.y)
            case .left: return Pos(x: pos.x - 1, y: pos.y)
            }
        }
    }

    enum GridType: Character {
        case empty = "."
        case wall = "#"
        case start = "^"
        case visited = "X"
        case turnedToTop = "┗"
        case turnedToRight = "┏"
        case turnedToBottom = "┓"
        case turnedToLeft = "┛"

        var isTurned: Bool {
            self == .turnedToTop || self == .turnedToRight || self == .turnedToBottom || self == .turnedToLeft
        }
    }


    struct Pos: Hashable {
        let x, y: Int
    }

    func isValid(pos: Pos) -> Bool {
        pos.x >= 0 && pos.y >= 0 && pos.x < grid[0].count && pos.y < grid.count
    }

    var gridDescription: String {
        self.grid.map { String($0.map { $0.rawValue }) + "\n" }.joined()
    }

    func run1(countNeeded: Bool = true) -> Int {
        var running = true
        let maxSteps = self.grid.count * self.grid[0].count
        var steps = 0
        var turnPositions: [Pos: Direction] = [:]

        while(running) {
            let newPos = self.currentDirection.nextPos(from: self.currentPos)
            guard isValid(pos: newPos) else {
                running = false
                break
            }
            switch (self.grid[newPos.y][newPos.x], currentDirection) {
            case (.turnedToTop, .left), (.turnedToRight, .up), (.turnedToBottom, .right), (.turnedToLeft, .down):
                return -1
            case (.empty, _), (.visited, _), (.start, _),
                (.turnedToTop, _), (.turnedToRight, _), (.turnedToBottom, _), (.turnedToLeft, _):
                self.currentPos = newPos
                self.grid[self.currentPos.y][self.currentPos.x] = .visited
            case (.wall, _):
                self.grid[self.currentPos.y][self.currentPos.x] = {
                    switch self.currentDirection {
                    case .up: return .turnedToRight
                    case .right: return .turnedToBottom
                    case .down: return .turnedToLeft
                    case .left: return .turnedToTop
                    }
                }()
                self.currentDirection = self.currentDirection.nextDirection()
            }

            steps += 1
            if steps >= maxSteps {
                return -1
            }

        }
        guard countNeeded else { return 1 }
        return self.grid.reduce(0) { partialResult, row in
            partialResult + row.reduce(0, { partialResult, type in
                partialResult + (type == .visited || type.isTurned ? 1 : 0)
            })
        }
    }

    func run2() -> Int {
        var counter = 0
        for y in 0..<self.grid.count {
            for x in 0..<self.grid[y].count {

                self.grid = self.originalGrid
                self.currentPos = self.originalStart
                self.currentDirection = .up

                switch self.grid[y][x] {
                case .empty, .start:
                    self.grid[y][x] = .wall
                    if self.run1(countNeeded: false) < 0 {
                        counter += 1
                    }
                case .visited, .turnedToTop, .turnedToRight, .turnedToBottom, .turnedToLeft, .wall:
                    break
                }
            }
        }
        return counter
    }
}

let puzzle2406Data1 = """
....#.....
.........#
..........
..#.......
.......#..
..........
.#..^.....
........#.
#.........
......#...
"""

let puzzle2406Data2 = """
.........#..................#.......#...............#..................................#.....................................#....
..#....................................#...#......#....................#..........................................................
..........................................................#..#.#................#............#....................#...............
...........................................................#......................................................#...............
............................#..........#................................................#............#.#....................#.....
...........#............................#............................................#...........................................#
......#..................#..#...........#.......................#..........#.....................#...........#...#......#.....#...
...#........................................................................................................#.............#.......
.......................#....................................#.....................#...#.#.....##.........................#........
..............#........#..............................................................................#..........#........#.......
.#........................................................................#....#..#....#.....................................#....
..........#.....................#....#.#.......................#................#.#.............#.......#.......#..........#......
......#..#...............................#.###......................................................#...#.........................
...............................................#....................#...#.......................#...........#...#.................
....#...#..#.............#................................................................#.......................................
...............#...#............#....................#.............#................#.......#....#.......................#........
.........#..........................#............#..............................................................#.#...............
..........................##..............................#....................................#..................................
.......#..##.........................#..............#..#......#..............#...............................##...................
.............................................#........................................................................#....#......
.........................#.......#.......#.......##.#.........#...................................................................
#......................................................................................#.......#......#.#................#......#.
...#.............#....#.............#.....................#................................................................#......
...........#.....................#............................#..............................#.....#........#.....................
.................#....#.#............#.....#................#.....................#..#............................................
..........................#......................#...............#.#...#..............................#.........#.................
...........................................................#......................................................#......#........
........#.........................#.................................#.....................................#.......................
....................#........#.....................................#...............#................#.......................#.....
....#...............#.............................................................................................................
##..................................................................................#.....................................#..#....
........................#..............#......#...................................#.........#.......#.....#.....#.................
.........#.............#......................#............#.......................................................#..........#...
.....#...............#......................................................................#.........#..................#........
....................#...#..............#...............#.............#.............#......#..#......#................#......#.....
............#..........................................#.........................................#........#.......................
.......#.....#........#....................#...............#............................................................#.........
..................#..#.............................................#........#..........................................#..........
...................................#...............................................................#.......#................#.#...
.......................#.....#.........#..................##........#.............................................................
.....#.................................................................................#............#........................#....
....#..........#.........#................................#.....................................#..................##.............
.#.........#..............#.................#...............................................#...............................#.....
........................#.......................................................#.....#................#..............#...........
.........................#.............................#.......#..................##..........................................#...
...................#...................#............#......#......................##........................#...#.....#...........
......#......#....#......................................................................................#........................
#............#........##............................#............................................#....#.......#.................#.
...........................................................#..............................................#.......#...#...........
...##...#............#.....#...............#..................#....................#..............#.............................#.
.....................................................................#................................#.......#.................#.
......#......#.......................................................#....#.................#.....................#...#.#....#.#..
...................#.........#..............#.................................#...#.......#.......................................
........##.....#.......#............................#...................................................................#.........
...................................#.........................................................................#...#...........#....
....#.....................................#......................................................#...#..........#.....#...........
..................................................................................................#........#....................#.
.........#....................##.................................#.......................#........#......#......................#.
.....#.....#....#............#..............#....#.........#............#.#...............#.......................#...............
...................................#.......................#..........................#.....................................#....#
..........#....#...........#.........#..............#.....#................................................#.........#............
...#.........#....................................................................................................................
.#.........................#........................................#.....#...................................#.............#.....
.......................#...#...#...#.......##..................##......................................#........................#.
............................................#....#..........................................##............................#.......
..#.................................................................#....#....#....##...........................................#.
.............#........#.#........#.....................##.....................................................#..#................
............................................##.......................................................................##...........
.........#...................#.................................#....#.#.............................#......#.#.#.....#.........#..
.........................#...........#...........#............................................#......#..................#.........
#.............................##...............#..........#...................#......................................#........#...
...................#.............................................................................................#.......#........
..........................................#.#......................................#........#...........##.......................#
...................#........#.#......#....................................#.......#...........................#..................#
......#................................................................................................#..........................
......................###.............#...................#.#...............................................#.....................
.....#......#......#.....#.#..................#.#...#.....................................................................#.......
.............................................#..............#....................##...............................................
.........................................#..#.............#................................................#...................#.#
........#............................#.................................................#..#.......................................
............#.............................#......................................#..........................##...#................
...................#.........#..................................................................#.............#...................
..#..#..............#....................#...................................................................#....................
............................#..................#..................................................................................
.........................#.....................................................................................#...............#..
.........#....................#.#.............##..................#...#...........................................................
........#..............................#..........................................#.#.........................#...................
.#........#....................##.............................................#............#......................................
...#.....................................#......#.#..#.....#............................#.......................................#.
....................#.........................................#.#.................................#.........#................#....
..............#..........#......#.........................#..#..................#..#...................#.................#...#....
................#..........................................#.............................#......#..............#.#...##...........
........................#.....#.......................#...#................#.......#................#.............................
........#..#..........#....#..#.............................................#...................#........#.................#.#....
...........................#.............................................................#..#................................#.#..
...........#.............#........................................#.^.................................................#...........
..........#.#..#......#........................................................................................#....#.............
...............#......#...#....#..................................#.......#.......................................................
..........##...##....#.....................#...#................................................................#......#..........
.............................................#................................................................................###.
........#.......#..........#....#....................#....................#....#.....#............................................
......#.............................................................................#...........##...#......##....................
.......#.............................#............#.......................#............#...#......................................
..#........#.....#......................................................................................................#.........
.....#....#......................#.....................................................................#..........................
.#.......#...........#....#.......#..............#...#..............#........#..........##.....#......#.................#.........
.............#.#....................................................#........#..............#.....#......................#...#....
...........#.............................................#...........................#.........##................#..#.....#.......
.........................................#.................................................................#.......#.#............
...............#....................#..........................#.............#......#....#...#..............#..................#..
........#...............#.........................................................................................................
..............................#............................#.#...................................#........#................#......
...........#........#.............................#...............................#................#.............#........#.......
.............................#...#..#...........#...........#.............................#..............................#........
......................................................................................................................#........#..
..............##...........#..........................................#...#..............#........................................
..............#.................#......................................................#..#........#..........................#...
..............................................#.......................#........................................................#..
.................#..#...................#..............................#.......................................#.#......#.........
...........#..........#................#.............#...................................................#.......#.....#..........
...#...#...............................................................................................#................#..#.#.#..
...#.....................................................................................#...............................#........
..........................#............................#.#..#..................#.#.......................#.#................##...#
...............................................................................................#....##............................
............................................#....................#....................................................#...........
...............#.......#...#.................................#.......................................#...#..#.#...................
.......#.....#.....#..................#..............#................#..........#........#.......................................
...#...#..........##....................#.......#.......#...........................#....................................#.....#..
..................................................#...#.#...#.........#.#.#.......##.....##.................................#.....
...#..#..........................#..#...........................#...............#.....#.......#............................#......
"""
